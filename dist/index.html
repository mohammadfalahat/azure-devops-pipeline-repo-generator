<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generate pipeline</title>
  <link rel="stylesheet" href="styles.css" />
  <script defer src="ui.js"></script>
</head>
<body>
  <main class="wrapper">
    <header>
      <div class="header-main">
        <img src="images/icon.svg" class="logo" alt="Extension icon" />
        <div>
          <h1>Generate pipeline</h1>
          <p id="branch-label">Loading branch context...</p>
        </div>
      </div>
      <button type="button" class="icon-button" id="open-settings" aria-controls="settings-panel" aria-expanded="false" title="Settings">⚙</button>
    </header>

    <section class="panel" id="token-gate">
      <div class="section-header">
        <div>
          <p class="eyebrow">Setup required</p>
          <h2>Personal access token needed</h2>
          <p class="hint">
            A verified personal access token is required before you can generate the pipeline. Tokens are stored only in this browser
            and are never shown again after saving.
          </p>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="primary" id="open-settings-from-gate">Open settings</button>
      </div>
      <div id="token-gate-message" role="status" aria-live="polite"></div>
    </section>

    <section class="panel hidden" id="pipeline-section">
      <p class="hint">
        Fill the fields below, then generate the pipeline and bootstrap the shared
        repository. Defaults match the requested deployment template.
      </p>
      <form id="pipeline-form">
        <div class="field">
          <label for="branch">Selected branch</label>
          <input id="branch" name="branch" disabled />
          <small>Captured from the branch list action and cannot be edited here.</small>
        </div>
        <div class="field">
          <label for="pool">Pool</label>
          <select id="pool" name="pool" required>
            <option value="">Loading pools...</option>
          </select>
          <small>Only pools (queues) that are accessible for this project are listed.</small>
        </div>
        <div class="field">
          <label for="service">Service name</label>
          <input id="service" name="service" required />
        </div>
        <div class="field">
          <label for="environment">Environment</label>
          <select id="environment" name="environment">
            <option value="dev">dev</option>
            <option value="demo" selected>demo</option>
            <option value="qa">qa</option>
            <option value="pro">pro</option>
          </select>
          <small>Defaults to the detected environment from the branch name but stays editable.</small>
        </div>
        <div class="field">
          <label for="dockerfileDir">Dockerfile directory</label>
          <input id="dockerfileDir" name="dockerfileDir" required />
          <small>Automatically scans the branch for Dockerfiles and pre-fills the directory. You can still override the value.</small>
        </div>
        <div class="field">
          <label for="repositoryAddress">Container registry URL</label>
          <input id="repositoryAddress" name="repositoryAddress" value="registry.buluttakin.com" required />
        </div>
        <div class="field">
          <label for="containerRegistryService">Container registry service</label>
          <select id="containerRegistryService" name="containerRegistryService" required>
            <option value="">Loading container registries...</option>
          </select>
        </div>
        <div class="field">
          <label for="komodoServer">Komodo server</label>
          <select id="komodoServer" name="komodoServer">
            <option value="DEMO-192.168.62.91">DEMO-192.168.62.91</option>
            <option value="Development-192.168.62.19">Development-192.168.62.19</option>
            <option value="Production-31.7.65.195">Production-31.7.65.195</option>
          </select>
        </div>
        <div class="field">
          <label for="targetRepo">Target repository name</label>
          <input id="targetRepo" name="targetRepo" readonly />
          <small>Auto-generated from the project name using the pattern SANITIZEDPROJECTNAME_Azure_DevOps.</small>
        </div>
        <button type="submit" class="primary">Create repository and pipeline scaffold</button>
      </form>
      <div id="status" role="status" aria-live="polite"></div>
    </section>

    <section class="panel hidden" aria-labelledby="settings-heading" id="settings-panel">
      <div class="section-header">
        <div>
          <p class="eyebrow">Settings</p>
          <h2 id="settings-heading">Personal access token</h2>
          <p class="hint">
            Provide an Azure DevOps PAT with repository access. The token is stored only in your browser
            (localStorage) and must be verified before the pipeline form is shown. Saved tokens cannot be viewed again.
          </p>
        </div>
        <button type="button" class="icon-button" id="close-settings" aria-label="Close settings">✕</button>
      </div>
      <form id="settings-form">
        <div class="field">
          <label for="personalToken">Token</label>
          <input id="personalToken" name="personalToken" type="password" autocomplete="off" spellcheck="false" placeholder="Paste token here" />
          <small>Tokens stay in this browser only and are never displayed after saving. A valid token is required to continue.</small>
        </div>
        <div class="actions">
          <button type="submit" class="primary">Save token</button>
          <button type="button" class="secondary" id="clear-token">Clear saved token</button>
        </div>
        <div id="token-status" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>
</body>
</html>
